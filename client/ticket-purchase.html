<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Покупка билета - TicketFlow</title>
    <!-- Библиотеки для генерации PDF и PNG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/print-page.css">

    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Простая визуализация как при создании мероприятия */
.seating-visualization-simple {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.visualization-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.hall-stage {
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    text-align: center;
}

.legend-simple {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

.color-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    border: 1px solid #ddd;
}

.free-dot { background: #4caf50; }
.taken-dot { background: #f44336; }
.selected-dot { background: #3a86ff; }

.simple-hall-layout {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    min-height: 300px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.simple-row {
    display: flex;
    gap: 4px;
    align-items: center;
}

.row-label {
    width: 30px;
    text-align: center;
    font-weight: bold;
    color: #666;
    font-size: 14px;
}

.simple-seat {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid #ddd;
    transition: all 0.2s ease;
}

.simple-seat.free {
    background: #4caf50;
    color: white;
    border-color: #388e3c;
}

.simple-seat.free:hover {
    background: #388e3c;
    transform: scale(1.05);
}

.simple-seat.taken {
    background: #f44336;
    color: white;
    border-color: #d32f2f;
    cursor: not-allowed;
}

.simple-seat.selected {
    background: #3a86ff;
    color: white;
    border-color: #1565c0;
    transform: scale(1.05);
    box-shadow: 0 0 0 2px #ffeb3b;
}

.selection-info-simple {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #e3f2fd;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
}

.selection-info-simple p {
    margin: 0;
    font-weight: 500;
}

/* Адаптивность */
@media (max-width: 768px) {
    .visualization-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .hall-stage {
        order: -1;
    }
    
    .legend-simple {
        justify-content: center;
    }
    
    .simple-seat {
        width: 24px;
        height: 24px;
        font-size: 10px;
    }
    
    .row-label {
        width: 25px;
        font-size: 12px;
    }
    
    .selection-info-simple {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}
        
        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-left: 4px solid #3a86ff;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left-color: #4caf50;
        }
        
        .notification.error {
            border-left-color: #f44336;
        }
        
        .notification.warning {
            border-left-color: #ff9800;
        }
        
        .notification.info {
            border-left-color: #3a86ff;
        }
        
        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            color: #4caf50;
        }
        
        .notification.error .notification-icon {
            color: #f44336;
        }
        
        .notification.warning .notification-icon {
            color: #ff9800;
        }
        
        .notification.info .notification-icon {
            color: #3a86ff;
        }
        
        .notification-content {
            flex-grow: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 14px;
            color: #666;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #999;
            flex-shrink: 0;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s, background 0.2s;
        }
        
        .notification-close:hover {
            color: #666;
            background: #f5f5f5;
        }
        
        /* Header Styles */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #3a86ff;
            cursor: pointer;
        }
        
        .logo span {
            color: #ff006e;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 25px;
        }
        
        nav ul li a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #3a86ff;
        }
        
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-buttons button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn {
            background: transparent;
            border: 1px solid #3a86ff;
            color: #3a86ff;
            margin-right: 10px;
        }
        
        .register-btn {
            background: #3a86ff;
            border: 1px solid #3a86ff;
            color: #fff;
        }
        
        .create-event-btn {
            background: #ff006e;
            border: 1px solid #ff006e;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .login-btn:hover {
            background: #f0f7ff;
        }
        
        .register-btn:hover {
            background: #2a75f0;
        }
        
        .create-event-btn:hover {
            background: #e00064;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3a86ff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .user-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 200px;
            padding: 10px 0;
            z-index: 1000;
            display: none;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown .user-info {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-weight: 500;
        }
        
        .user-dropdown .user-role {
            display: block;
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }
        
        .user-dropdown a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: #333;
            transition: background 0.3s;
        }
        
        .user-dropdown a:hover {
            background: #f5f7fa;
        }
        
        .user-dropdown a i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }
        
        .admin-link {
            color: #ff006e !important;
            font-weight: 500;
        }
        
        /* Page Content */
        .page-content {
            display: none;
            min-height: 60vh;
            padding: 30px 0;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #3a86ff 0%, #8338ec 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .hero p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto 30px;
        }
        
        /* Search Form */
        .search-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: -40px auto 0;
            position: relative;
            z-index: 10;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .search-btn, .submit-btn {
            background: #ff006e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }
        
        .search-btn:hover, .submit-btn:hover {
            background: #e00064;
        }
        
        /* Events Section */
        .section-title {
            text-align: center;
            margin: 50px 0 30px;
            font-size: 2rem;
            color: #333;
        }
        
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .event-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .event-card:hover {
            transform: translateY(-5px);
        }
        
        .event-image {
            height: 180px;
            background-color: #8338ec;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }
        
        .event-details {
            padding: 20px;
        }
        
        .event-date {
            color: #3a86ff;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .event-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        .event-location {
            color: #666;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .event-price {
            font-weight: 700;
            font-size: 1.2rem;
            color: #ff006e;
            margin-bottom: 15px;
        }
        
        .book-btn {
            background: #3a86ff;
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .book-btn:hover {
            background: #2a75f0;
        }
        
        /* Categories Section */
        .categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 50px;
        }
        
        .category {
            background: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category:hover {
            background: #3a86ff;
            color: white;
        }
        
        /* Create Event Form */
        .create-event-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #3a86ff;
        }
        
        /* Footer */
        footer {
            background: #2d3748;
            color: white;
            padding: 50px 0 20px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-column h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #3a86ff;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column ul li a {
            color: #cbd5e0;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-column ul li a:hover {
            color: white;
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #4a5568;
            color: #cbd5e0;
        }
        
        /* Auth Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .auth-modal {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: #3a86ff;
            color: white;
            padding: 20px;
            position: relative;
            text-align: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .modal-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .modal-tab.active {
            background: white;
            font-weight: 500;
            border-bottom: 2px solid #3a86ff;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-form {
            display: none;
        }
        
        .modal-form.active {
            display: block;
        }
        
        .form-input {
            margin-bottom: 20px;
        }
        
        .form-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-input input:focus {
            border-color: #3a86ff;
            outline: none;
        }
        
        .modal-submit {
            background: #3a86ff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .modal-submit:hover {
            background: #2a75f0;
        }
        
        .form-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .form-footer a {
            color: #3a86ff;
            text-decoration: none;
        }
        
        .admin-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .admin-checkbox input {
            margin-right: 8px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin: 15px 0;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li {
                margin: 5px 10px;
            }
            
            .header-buttons {
                margin-top: 10px;
                flex-direction: column;
                gap: 10px;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .auth-modal {
                width: 90%;
            }
            
            .notification {
                max-width: 300px;
            }
        }

        /* Стили для модального окна билетов */
.tickets-modal {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  background: linear-gradient(135deg, #3a86ff 0%, #8338ec 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
}

.close-modal {
  background: none;
  border: none;
  color: white;
  font-size: 1.8rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.close-modal:hover {
  background: rgba(255, 255, 255, 0.2);
}

.modal-body {
  padding: 20px;
  max-height: calc(80vh - 80px);
  overflow-y: auto;
}

.tickets-summary {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.summary-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}

.summary-item i {
  color: #3a86ff;
  font-size: 16px;
  width: 20px;
}

.tickets-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
  max-height: 400px;
  overflow-y: auto;
  padding: 5px;
}


.ticket-item:hover {
  border-color: #3a86ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(58, 134, 255, 0.1);
}

.ticket-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.ticket-code {
  font-family: 'Courier New', monospace;
  font-weight: bold;
  font-size: 1.1rem;
  color: #3a86ff;
  background: #f0f7ff;
  padding: 4px 8px;
  border-radius: 4px;
}

.ticket-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-active {
  background: #4caf50;
  color: white;
}

.status-used {
  background: #ff9800;
  color: white;
}

.status-invalid {
  background: #f44336;
  color: white;
}

.ticket-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.ticket-info-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ticket-label {
  font-size: 0.8rem;
  color: #666;
  font-weight: 500;
}

.ticket-value {
  font-weight: 600;
  color: #333;
}

.ticket-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 10px;
}

.ticket-action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.2s;
}

.ticket-action-btn:hover {
  transform: translateY(-1px);
}

.btn-view {
  background: #3a86ff;
  color: white;
}

.btn-invalidate {
  background: #ff6b6b;
  color: white;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

/* Анимация появления билетов */
.ticket-item {
  animation: ticketAppear 0.4s ease;
}

@keyframes ticketAppear {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Адаптивность */
@media (max-width: 768px) {
  .tickets-modal {
    width: 95%;
    margin: 10px;
  }
  
  .tickets-summary {
    grid-template-columns: 1fr;
  }
  
  .ticket-info {
    grid-template-columns: 1fr;
  }
  
  .modal-actions {
    flex-direction: column;
  }
  
  .modal-actions button {
    width: 100%;
  }
}

/* Стили для печати */
@media print {
  .modal-header,
  .modal-actions,
  .ticket-actions {
    display: none !important;
  }
  
  .tickets-modal {
    box-shadow: none;
    max-width: none;
    max-height: none;
  }
  
  .ticket-item {
    break-inside: avoid;
    border: 2px solid #000;
  }
}

        /* Стили для информации о билетах */
.tickets-info {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 20px;
    border-left: 4px solid #4caf50;
}

.tickets-info h3 {
    margin: 0 0 15px 0;
    color: #333;
}


.ticket-item {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #3a86ff;
}

.ticket-code {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #3a86ff;
}

.ticket-seat {
    color: #666;
}

.ticket-price {
    font-weight: bold;
    color: #ff006e;
    text-align: right;
}

/* Адаптивность */
@media (max-width: 768px) {
    .ticket-item {
        grid-template-columns: 1fr;
        gap: 5px;
    }
    
    .ticket-price {
        text-align: left;
    }
}

/* Гарантируем отображение элементов */
.hall-visualization {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.hall-layout {
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-height: 200px;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.hall-row {
    display: flex;
    gap: 3px;
    align-items: center;
}

.row-number {
    width: 30px;
    text-align: center;
    font-weight: bold;
    color: #666;
}

.seat {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid #ddd;
    transition: all 0.2s ease;
}

.seat.free {
    background: #4caf50;
    color: white;
}

.seat.free:hover {
    background: #3d8b40;
    transform: scale(1.1);
}

.seat.taken {
    background: #f44336;
    color: white;
    cursor: not-allowed;
}

.seat.selected {
    background: #3a86ff;
    color: white;
    border: 2px solid #ffeb3b;
}

.hall-stage {
    background: #333;
    color: white;
    text-align: center;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    font-weight: bold;
}

/* Сообщения об ошибках */
.error {
    color: #f44336;
    padding: 20px;
    text-align: center;
    background: #ffebee;
    border-radius: 5px;
    border: 1px solid #f44336;
}
        

/* Стили для билетов */
.tickets-container {
  display: grid;
  gap: 20px;
  margin: 30px 0;
}

.ticket-card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  border-left: 4px solid #3a86ff;
}

.ticket-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

.ticket-code {
  font-family: 'Courier New', monospace;
  font-weight: bold;
  font-size: 1.2rem;
  color: #3a86ff;
}

.ticket-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-active {
  background: #4caf50;
  color: white;
}

.status-used {
  background: #ff9800;
  color: white;
}

.status-invalid {
  background: #f44336;
  color: white;
}

.ticket-info h3 {
  margin-bottom: 10px;
  color: #333;
}

.ticket-info p {
  margin-bottom: 8px;
  color: #666;
  display: flex;
  align-items: center;
}

.ticket-info i {
  margin-right: 8px;
  width: 16px;
  color: #3a86ff;
}

.ticket-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
}

.no-tickets {
  text-align: center;
  padding: 40px;
  color: #666;
}

.no-tickets i {
  font-size: 3rem;
  color: #ddd;
  margin-bottom: 15px;
}

.no-tickets h3 {
  margin-bottom: 10px;
  color: #333;
}

/* Кнопки */
.btn-secondary {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-warning {
  background: #ff9800;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-warning:hover {
  background: #e68a00;
}

/* Обновляем стили кнопки покупки */
.book-btn {
  background: #3a86ff;
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  width: 100%;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 16px;
}

.book-btn:hover {
  background: #2a75f0;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.book-btn:active {
  transform: translateY(0);
}

/* Стиль для неактивной кнопки */
.book-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Адаптивность для мобильных устройств */
@media (max-width: 768px) {
  .book-btn {
    padding: 10px 16px;
    font-size: 14px;
  }
}

.event-id {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
  font-family: 'Courier New', monospace;
}

        .ticket-purchase-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .purchase-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .purchase-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .event-details-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }
        
        .event-image-large {
            width: 100%;
            height: 200px;
            background-color: #8338ec;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            background-size: cover;
            background-position: center;
        }
        
        .event-info h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .event-info-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #666;
        }
        
        .event-info-item i {
            width: 20px;
            margin-right: 10px;
            color: #3a86ff;
        }
        
        .ticket-form-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #3a86ff;
            background: white;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-display {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        
        .price-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .price-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }
        
        .purchase-btn {
            background: #ff006e;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        .purchase-btn:hover {
            background: #e00064;
        }
        
        .purchase-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .ticket-notice {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #3a86ff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #d32f2f;
        }
        
        @media (max-width: 768px) {
            .purchase-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="window.location.href='/'">Ticket<span>Flow</span></div>
                <nav>
                    <ul>
                        <li><a href="/">Главная</a></li>
                        <li><a href="#" onclick="history.back()">Назад</a></li>
                    </ul>
                </nav>
                <div class="header-buttons" id="headerAuthButtons">
                    <!-- Будет заполнено скриптом -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="ticket-purchase-container">
                <div class="purchase-header">
                    <h1>Покупка билета</h1>
                    <p>Заполните информацию для завершения покупки</p>
                </div>
                
                <div id="loading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Загрузка информации о мероприятии...</p>
                </div>
                
                <div id="errorContainer" class="error-message" style="display: none;">
                    <!-- Сообщения об ошибках -->
                </div>
                
                <div id="purchaseContent" style="display: none;">
                    <div class="purchase-content">
                        <!-- Левая колонка - Информация о мероприятии -->
                        <div class="event-details-card">
                            <div class="event-image-large" id="eventImage">
                                Загрузка изображения...
                            </div>
                            <div class="event-info">
                                <h2 id="eventTitle">Название мероприятия</h2>
                                <div class="event-info-item">
                                    <i class="fas fa-calendar"></i>
                                    <span id="eventDate">Дата загрузки...</span>
                                </div>
                                <div class="event-info-item">
                                    <i class="fas fa-clock"></i>
                                    <span id="eventTime">Время загрузки...</span>
                                </div>
                                <div class="event-info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="eventLocation">Место загрузки...</span>
                                </div>
                                <div class="event-info-item">
                                    <i class="fas fa-user"></i>
                                    <span id="eventOrganizer">Организатор загрузки...</span>
                                </div>
                                <div class="event-info-item">
                                    <i class="fas fa-ticket-alt"></i>
                                    <span id="eventTickets">Доступно билетов: загрузка...</span>
                                </div>
                                <div class="event-description">
                                    <p id="eventDescription">Описание загружается...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Правая колонка - Форма покупки -->
                        <div class="ticket-form-card">
                            <h3>Данные для покупки</h3>
                            
                            <div class="form-group">
                                <label>Количество билетов</label>
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                                    <span class="quantity-display" id="quantity">1</span>
                                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                                </div>
                                <small>Максимально доступно: <span id="maxTickets">0</span> билетов</small>
                            </div>
                            
                            <label for="fruits">Выберите фрукт:</label>
<select id="fruits" name="fruits">
  <option value="apple">Яблоко</option>
  <option value="banana">Банан</option>
  <option value="orange">Апельсин</option>
  <option value="pear">Груша</option>
</select>

                            <div class="price-summary">
                                <h4>Стоимость</h4>
                                <div class="price-item">
                                    <span>Цена за билет:</span>
                                    <span id="ticketPrice">0 тг.</span>
                                </div>
                                <div class="price-item">
                                    <span>Количество:</span>
                                    <span id="quantitySummary">1 шт.</span>
                                </div>
                                <div class="price-total">
                                    <span>Итого:</span>
                                    <span id="totalPrice">0 тг.</span>
                                </div>
                            </div>
                            
                            <div id="userInfo" style="display: none;">
                                <div class="form-group">
                                    <label>Покупатель</label>
                                    <p><strong id="userName">Имя пользователя</strong></p>
                                    <p id="userEmail">Email пользователя</p>
                                </div>
                            </div>
                            
                            <div id="authRequired" style="display: none;">
                                <div class="error-message">
                                    <p>Для покупки билетов необходимо войти в систему</p>
                                </div>
                                <button class="purchase-btn" onclick="window.location.href='/?login=true'">
                                    Войти в систему
                                </button>
                            </div>
                            
                           <button id="purchaseButton" class="purchase-btn" onclick="purchaseTickets()">
                                Купить билеты
                            </button>

                       
                           
                            
                            <div class="ticket-notice">
                                <h4><i class="fas fa-info-circle"></i> Важная информация</h4>
                                <p>После покупки вы получите билеты с уникальными кодами. 
                                   Билеты можно будет найти в разделе "Мои билеты".</p>
                                <p>Каждый билет имеет статус: <strong>Активен</strong>, 
                                   <strong>Использован</strong> или <strong>Недействителен</strong>.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
                                    <!-- Добавляем после формы покупки -->
<!-- Модальное окно успешной покупки -->
<div class="modal-overlay" id="purchaseSuccessModal">
  <div class="tickets-modal">
    <div class="modal-header">
      <h2>Покупка успешна! 🎉</h2>
      <button class="close-modal" onclick="closePurchaseSuccessModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="purchase-success-content">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        
        <div class="success-message">
          <h3>Вы успешно приобрели билеты!</h3>
          <p>Куплено <strong id="purchasedTicketsCount">0</strong> билетов на сумму <strong id="purchasedTotalPrice">0</strong> тг.</p>
        </div>
        
        <div class="ticket-codes-preview">
          <h4>Коды ваших билетов:</h4>
          <div class="codes-preview-container" id="ticketCodesPreview"></div>
        </div>
        
        <div class="purchase-actions">
          <button class="btn-primary" onclick="closePurchaseSuccessModal()">
            <i class="fas fa-check"></i> Отлично!
          </button>
          <button class="btn-secondary" onclick="openPrintPage()">
            <i class="fas fa-print"></i> Печать билетов
          </button>
          <button class="btn-secondary" onclick="copyAllTicketCodes()">
            <i class="fas fa-copy"></i> Копировать коды
          </button>
        </div>
      </div>
    </div>
  </div>
                                </div>
  </div>
</div>
<!-- Страница для печати билетов -->
<div id="printPage" style="display: none;">
  <div class="print-container">
    <header class="print-header">
      <div class="print-logo">
        <h1>Ticket<span>Flow</span></h1>
        <p>Ваши билеты</p>
      </div>
      <div class="print-event-info">
        <h2 id="printEventTitle"></h2>
        <p id="printEventDate"></p>
        <p id="printEventLocation"></p>
      </div>
      <div class="print-controls no-print">
    <button class="btn-secondary" onclick="closePrintPage()">
      <i class="fas fa-arrow-left"></i> Назад
    </button>
    <button class="btn-primary" onclick="window.print()">
      <i class="fas fa-print"></i> Печать
    </button>
    <button class="btn-secondary" onclick="downloadAsPDF()">
      <i class="fas fa-file-pdf"></i> Скачать PDF
    </button>
  </div>
    </header>

    <div class="print-tickets" id="printTicketsContainer">
      <!-- Билеты будут добавлены здесь -->
    </div>

    <footer class="print-footer">
      <p>Билеты сгенерированы: <span id="printGenerationDate"></span></p>
      <p>При возникновении вопросов обращайтесь в поддержку: support@ticketflow.ru</p>
    </footer>
  </div>
</div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>О нас</h3>
                    <ul>
                        <li><a href="#">О компании</a></li>
                        <li><a href="#">Контакты</a></li>
                        <li><a href="#">Партнеры</a></li>
                        <li><a href="#">Рекламодателям</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Помощь</h3>
                    <ul>
                        <li><a href="#">Как купить билет</a></li>
                        <li><a href="#">Вопросы и ответы</a></li>
                        <li><a href="#">Правила использования</a></li>
                        <li><a href="#">Политика конфиденциальности</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Контакты</h3>
                    <ul>
                        <li>Телефон: +7 (800) 123-45-67</li>
                        <li>Email: info@ticketflow.ru</li>
                        <li>Адрес: Москва, ул. Примерная, д. 10</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Подписка</h3>
                    <p>Подпишитесь на рассылку, чтобы получать информацию о новых мероприятиях и акциях</p>
                    <form>
                        <input type="email" placeholder="Ваш email" style="padding: 10px; width: 100%; margin: 10px 0; border-radius: 4px; border: none;">
                        <button type="submit" class="search-btn" style="margin-top: 10px;">Подписаться</button>
                    </form>
                </div>
            </div>
            <div class="copyright">
                <p>© 2023 TicketFlow. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script src="/js/auth.js"></script>
    <script src="/js/notifications.js"></script>

    <script>
        // Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Автоматическая инициализация через небольшую задержку
    setTimeout(() => {
        if (currentEvent) {
            initSimpleHall();
        }
    }, 500);
});
        // Глобальные переменные
        let currentEvent = null;
        let currentQuantity = 1;
        let ticketPrice = 0;
        
        
        
        // Инициализация страницы
        // Инициализация страницы
async function initPage() {
  // Получаем ID мероприятия из URL
  const pathParts = window.location.pathname.split('/');
  const eventId = pathParts[2]; // /event/:id/tickets
  
  if (!eventId) {
    showError('Мероприятие не указано');
    return;
  }
  
  // Загружаем информацию о мероприятии
  await loadEventInfo(eventId);
  
  // Обновляем интерфейс в зависимости от авторизации
  updatePurchaseUI();
  
  // Обновляем стоимость
  updatePrice();

}

// Закрытие модального окна по клику вне области
document.addEventListener('click', function(e) {
  const modal = document.getElementById('ticketsModal');
  if (modal && modal.classList.contains('active') && e.target === modal) {
    closeTicketsModal();
  }
});

// Закрытие по клавише Escape
document.addEventListener('keydown', function(e) {
  const modal = document.getElementById('ticketsModal');
  if (modal && modal.classList.contains('active') && e.key === 'Escape') {
    closeTicketsModal();
  }
});
        

//         // Загрузка информации о мероприятии
// async function loadEventInfo(eventId) {
//   try {
//     const response = await fetch(`/api/events/id/${eventId}`);
//     const data = await response.json();
    
//     if (data.status === 'success') {
//       currentEvent = data.event;
//       displayEventInfo();
//       hideLoading();
//     } else {
//       showError(data.message || 'Ошибка при загрузке информации о мероприятии');
//     }
//   } catch (error) {
//     console.error('Ошибка:', error);
//     showError('Ошибка сети при загрузке информации о мероприятии');
//   }
//}
        
        // Отображение информации о мероприятии
        function displayEventInfo() {
            if (!currentEvent) return;
            
            // Заполняем информацию о мероприятии
            document.getElementById('eventTitle').textContent = currentEvent.title;
            document.getElementById('eventDescription').textContent = currentEvent.description;
            
            // Форматируем дату
            const eventDate = new Date(currentEvent.date).toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('eventDate').textContent = eventDate;
            
            document.getElementById('eventTime').textContent = currentEvent.time;
            document.getElementById('eventLocation').textContent = `${currentEvent.venue}, ${currentEvent.city}`;
            document.getElementById('eventOrganizer').textContent = `Организатор: ${currentEvent.organizer}`;
            document.getElementById('eventTickets').textContent = `Доступно билетов: ${currentEvent.ticketsAvailable}`;
            
            // Устанавливаем изображение
            const eventImage = document.getElementById('eventImage');
            if (currentEvent.image) {
                eventImage.style.backgroundImage = `url('${currentEvent.image}')`;
                eventImage.textContent = '';
            } else {
                eventImage.textContent = currentEvent.title;
            }
            
            // Устанавливаем цену и максимальное количество
            ticketPrice = currentEvent.price;
            document.getElementById('ticketPrice').textContent = `${ticketPrice} тг.`;
            document.getElementById('maxTickets').textContent = currentEvent.ticketsAvailable;
            
            // Обновляем доступность покупки
            updatePurchaseButton();
        }
        
        // Изменение количества билетов
        // Обновляем функцию изменения количества билетов
// Обновляем функцию изменения количества
function changeQuantity(delta) {
    const newQuantity = currentQuantity + delta;
    const maxTickets = currentEvent ? currentEvent.ticketsAvailable : 0;
    
    if (newQuantity >= 1 && newQuantity <= maxTickets) {
        currentQuantity = newQuantity;
        document.getElementById('quantity').textContent = currentQuantity;
        updatePrice();
        
        // Если превысили лимит выбора - очищаем лишнее
        if (selectedSeats.length > currentQuantity) {
            selectedSeats = selectedSeats.slice(0, currentQuantity);
            initSimpleHall();
        }
        
    }
}
        
        // Обновление стоимости
        function updatePrice() {
            const total = currentQuantity * ticketPrice;
            const amount = currentQuantity;
            document.getElementById('totalPrice').textContent = `${total} тг.`;
            document.getElementById('quantitySummary').textContent = `${amount} шт.`;
        }

       
        
        // Обновление интерфейса покупки
        function updatePurchaseUI() {
            const isAuthenticated = auth.isAuthenticated();
            const userInfo = document.getElementById('userInfo');
            const authRequired = document.getElementById('authRequired');
            const purchaseButton = document.getElementById('purchaseButton');
            
            if (isAuthenticated) {
                userInfo.style.display = 'block';
                authRequired.style.display = 'none';
                purchaseButton.style.display = 'block';
                
                document.getElementById('userName').textContent = auth.user.name;
                document.getElementById('userEmail').textContent = auth.user.email;
            } else {
                userInfo.style.display = 'none';
                authRequired.style.display = 'block';
                purchaseButton.style.display = 'none';
            }
        }
        
        // Обновление кнопки покупки
        function updatePurchaseButton() {
            const purchaseButton = document.getElementById('purchaseButton');
            const isAuthenticated = auth.isAuthenticated();
            const hasTickets = currentEvent && currentEvent.ticketsAvailable > 0;
            
            if (isAuthenticated && hasTickets && currentQuantity > 0) {
                purchaseButton.disabled = false;
                purchaseButton.textContent = `Купить билет`;
            } else {
                purchaseButton.disabled = true;
            }
        }
        
        // Покупка билетов
        // Обновляем функцию покупки билетов
// Обновляем функцию покупки
async function purchaseTickets() {
  if (!auth.isAuthenticated()) {
    notifications.warning('Требуется авторизация', 'Для покупки билетов необходимо войти в систему!');
    return;
  }

  // Для reserved seating проверяем выбранные места
  if (currentEventSeatingConfig && currentEventSeatingConfig.type === 'reserved') {
    if (selectedSeats.length !== currentQuantity) {
      notifications.error('Ошибка', `Выберите ${currentQuantity} мест(а) для покупки`);
      return;
    }
  }

  try {
    const result = await ticketsManager.purchaseTicket(
      currentEvent._id, 
      currentQuantity, 
      '', 
      currentEventSeatingConfig.type === 'reserved' ? selectedSeats : []
    );
    
    if (result.success) {
      console.log('Успех!', result.message);
      // Дополнительные действия после покупки...
    } else {
      console.log('Ошибка', result.message);
    }
  } catch (error) {
    console.log('Ошибка', 'Не удалось完成 покупку');
  }
}
// Обновленная функция покупки билетов
async function purchaseTickets() {
    console.log('Начало покупки билетов...');
    
    // Проверяем авторизацию
    if (!auth.isAuthenticated()) {
       console.log('warning', 'Требуется авторизация', 'Для покупки билетов необходимо войти в систему');
        openLoginModal();
        return;
    }

    // Проверяем доступность мероприятия
    if (!currentEvent || !currentEvent._id) {
         console.log('error', 'Ошибка', 'Мероприятие не выбрано');
        return;
    }

    // Проверяем тип рассадки и выбранные места
    const seatingConfig = currentEvent.seatingConfig || { type: 'free' };
    
    if (seatingConfig.type === 'reserved') {
        // Для reserved seating проверяем выбранные места
        if (selectedSeats.length === 0) {
             console.log('error', 'Ошибка', 'Выберите места для покупки');
            return;
        }
        
        if (selectedSeats.length !== currentQuantity) {
            console.log('error', 'Ошибка', `Выберите ${currentQuantity} мест(а)`);
            return;
        }
    }

    // Показываем загрузку
    const purchaseBtn = document.getElementById('purchaseButton');
    const originalText = purchaseBtn.textContent;
    purchaseBtn.disabled = true;
    purchaseBtn.textContent = 'Покупка...';

    try {
        console.log('Отправка запроса на покупку...');
        
        // Подготавливаем данные для отправки
        const requestData = {
            eventId: currentEvent._id,
            quantity: currentQuantity
        };

        // Добавляем выбранные места для reserved seating
        if (seatingConfig.type === 'reserved' && selectedSeats.length > 0) {
            requestData.selectedSeats = selectedSeats;
        }

        // Отправляем запрос
        const response = await fetch('/api/tickets/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${auth.token}`
            },
            body: JSON.stringify(requestData)
        });

        // Проверяем ответ
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Ответ сервера:', result);

        if (result.status === 'success') {
            // Успешная покупка
            console.log('success', 'Успех!', result.message);
            
            // Показываем информацию о билетах
            showPurchaseSuccessModal(tickets);
            
            // Перенаправляем на страницу профиля через 3 секунды
            // setTimeout(() => {
            //     window.location.href = '/profile?tickets=true';
            // }, 3000);
            
        } else {
            // Ошибка от сервера
            console.log('error', 'Ошибка', result.message || 'Неизвестная ошибка');
        }

    } catch (error) {
        console.error('Ошибка покупки:', error);
        console.log('error', 'Ошибка', 'Не удалось完成 покупку. Попробуйте еще раз.');
    } finally {
        // Восстанавливаем кнопку
        purchaseBtn.disabled = false;
        purchaseBtn.textContent = originalText;
    }
}

// Открытие модального окна
function openTicketsModal() {
  const modal = document.getElementById('ticketsModal');
  if (modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; // Блокируем прокрутку фона
  }
}

// Закрытие модального окна
function closeTicketsModal() {
  const modal = document.getElementById('ticketsModal');
  if (modal) {
    modal.classList.remove('active');
    document.body.style.overflow = ''; // Восстанавливаем прокрутку
  }
}

// Обновление содержимого модального окна
function updateTicketsModal(tickets) {
  // Обновляем summary
  updateTicketsSummary(tickets);
  
  // Обновляем список билетов
  updateTicketsList(tickets);
}

// Обновление summary информации
function updateTicketsSummary(tickets) {
  const totalTickets = tickets.length;
  const totalPrice = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
  const purchaseDate = new Date().toLocaleDateString('ru-RU');
  
  document.getElementById('ticketsCount').textContent = totalTickets;
  document.getElementById('ticketsTotalPrice').textContent = totalPrice;
  document.getElementById('purchaseDate').textContent = purchaseDate;
}

// Обновление списка билетов
function updateTicketsList(tickets) {
  const ticketsList = document.getElementById('ticketsList');
  ticketsList.innerHTML = '';
  
  tickets.forEach((ticket, index) => {
    const ticketElement = createTicketElement(ticket, index);
    ticketsList.appendChild(ticketElement);
  });
}

// Создание элемента билета
function createTicketElement(ticket, index) {
  const ticketDiv = document.createElement('div');
  ticketDiv.className = 'ticket-item';
  ticketDiv.style.animationDelay = `${index * 0.1}s`;
  
  const eventDate = ticket.event?.date ? new Date(ticket.event.date).toLocaleDateString('ru-RU') : '-';
  const eventTime = ticket.event?.time || '-';
  
  ticketDiv.innerHTML = `
    <div class="ticket-header">
      <span class="ticket-code">${ticket.code || 'N/A'}</span>
      <span class="ticket-status status-${getStatusClass(ticket.status)}">
        ${ticket.status || 'Активен'}
      </span>
    </div>
    
    <div class="ticket-info">
      <div class="ticket-info-item">
        <span class="ticket-label">Мероприятие</span>
        <span class="ticket-value">${ticket.event?.title || 'Неизвестно'}</span>
      </div>
      
      <div class="ticket-info-item">
        <span class="ticket-label">Дата и время</span>
        <span class="ticket-value">${eventDate}, ${eventTime}</span>
      </div>
      
      <div class="ticket-info-item">
        <span class="ticket-label">Место</span>
        <span class="ticket-value">${ticket.seat || 'Не указано'}</span>
      </div>
      
      <div class="ticket-info-item">
        <span class="ticket-label">Цена</span>
        <span class="ticket-value">${ticket.price || 0} тг.</span>
      </div>
      
      <div class="ticket-info-item">
        <span class="ticket-label">Место проведения</span>
        <span class="ticket-value">${ticket.event?.venue || '-'}, ${ticket.event?.city || '-'}</span>
      </div>
      
      <div class="ticket-info-item">
        <span class="ticket-label">Статус</span>
        <span class="ticket-value">${ticket.status || 'Активен'}</span>
      </div>
    </div>
  `;
  
  return ticketDiv;
}

// Вспомогательная функция для получения класса статуса
function getStatusClass(status) {
  const statusMap = {
    'Активен': 'active',
    'Использован': 'used',
    'Недействителен': 'invalid'
  };
  return statusMap[status] || 'active';
}

function printTickets() {
  const printContent = document.getElementById('purchaseSuccessModal').cloneNode(true);
  
  // Убираем ненужные элементы для печати
  const elementsToRemove = printContent.querySelectorAll('.modal-header, .purchase-actions, .close-modal');
  elementsToRemove.forEach(el => el.remove());
  
  // Создаем временное окно для печати
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Билеты на ${currentEvent.title}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .qr-code-item { margin: 10px; display: inline-block; text-align: center; }
        .qr-code-container { margin: 0 auto; }
        .ticket-code-badge { 
          background: #000; color: #fff; padding: 5px 10px; 
          margin: 2px; border-radius: 10px; font-family: monospace;
        }
        @media print {
          .qr-code-item { break-inside: avoid; }
        }
      </style>
    </head>
    <body>
      <h1>Билеты на: ${currentEvent.title}</h1>
      <p>Дата: ${new Date(currentEvent.date).toLocaleDateString('ru-RU')} в ${currentEvent.time}</p>
      <p>Место: ${currentEvent.venue}, ${currentEvent.city}</p>
      <hr>
      ${printContent.innerHTML}
    </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.focus();
  
  // Даем время на загрузку изображений
  setTimeout(() => {
    printWindow.print();
    // printWindow.close(); // Можно раскомментировать для автоматического закрытия
  }, 500);
}

// Просмотр деталей билета
function viewTicketDetails(ticketCode) {
  // Здесь можно реализовать просмотр детальной информации
  alert(`Детальная информация о билете ${ticketCode}`);
  
  // Или открыть отдельное модальное окно с QR-кодом и полной информацией
  // openTicketDetailsModal(ticketCode);
}

// Аннулирование билета
function invalidateTicket(ticketCode) {
  if (confirm(`Вы уверены, что хотите аннулировать билет ${ticketCode}?`)) {
    // Здесь будет вызов API для аннулирования билета
    alert('Аннулирование! Билет ${ticketCode} аннулирован');
    
    // Обновляем статус в интерфейсе
    updateTicketStatus(ticketCode, 'Недействителен');
  }
}

// Обновление статуса билета в интерфейсе
function updateTicketStatus(ticketCode, newStatus) {
  const ticketElements = document.querySelectorAll('.ticket-item');
  ticketElements.forEach(element => {
    const codeElement = element.querySelector('.ticket-code');
    if (codeElement && codeElement.textContent === ticketCode) {
      const statusElement = element.querySelector('.ticket-status');
      if (statusElement) {
        statusElement.textContent = newStatus;
        statusElement.className = `ticket-status status-${getStatusClass(newStatus)}`;
      }
    }
  });
}

// Функция показа информации о билетах
// Модальное окно информации о билетах
function showTicketsInfo(tickets) {
  if (!tickets || tickets.length === 0) {
    alert('Нет билетов! У вас пока нет купленных билетов');
    return;
  }

  // Открываем модальное окно
  openTicketsModal();
  
  // Обновляем информацию
  updateTicketsModal(tickets);
  // Также можно показать в интерфейсе
    const ticketContainer = document.createElement('div');
    ticketContainer.className = 'tickets-info';
    ticketContainer.innerHTML = `
        <h3>Ваши билеты</h3>
        <div class="tickets-list">
            ${tickets.map(ticket => `
                <div class="ticket-item">
                    <div class="ticket-code">${ticket.code}</div>
                    <div class="ticket-seat">${ticket.seat || 'Место будет назначено'}</div>
                    <div class="ticket-price">${ticket.price} тг.</div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.querySelector('.purchase-content').appendChild(ticketContainer);
}

    //ticketInfo += 'Сохраните эту информацию! Билеты также доступны в вашем профиле.';
    
    
    

        
        // Вспомогательные функции
        function getPluralEnding(number) {
            if (number % 10 === 1 && number % 100 !== 11) return '';
            if ([2, 3, 4].includes(number % 10) && ![12, 13, 14].includes(number % 100)) return 'а';
            return 'ов';
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<p>${message}</p>`;
            errorContainer.style.display = 'block';
            hideLoading();
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('purchaseContent').style.display = 'block';
        }

        // Обновляем функцию загрузки мероприятия
async function loadEventInfo(eventId) {
    try {
          const response = await fetch(`/api/events/id/${eventId}`);
        const data = await response.json();
        

        if (data.status === 'success') {
            currentEvent = data.event;
            displayEventInfo();
        hideLoading();
            
            // Загружаем занятые места
            await loadTakenSeats(eventId);
            
            // Инициализируем простой зал
            initSimpleHall();
            
        } else {
            console.error('Ошибка загрузки:', data.message);
        }
    } catch (error) {
        console.error('Ошибка сети:', error);
    }
}



// Глобальные переменные
let selectedSeats = [];
let takenSeats = [];
let currentEventSeatingConfig = null;

// Инициализация выбора мест
async function initSeatSelection() {
  if (!currentEvent) return;
  
  // Загружаем конфигурацию мест
  currentEventSeatingConfig = currentEvent.seatingConfig || { type: 'free' };
  
  // Загружаем занятые места
  await loadTakenSeats(currentEvent._id);
  
  // Показываем интерфейс выбора мест
  showSeatSelectionInterface();
  
  // Визуализируем зал
  visualizeHallForPurchase();
  
  // Обновляем статистику
  updateSelectionStats();
}

// Показываем интерфейс выбора мест
function showSeatSelectionInterface() {
  const selectionSection = document.querySelector('.seating-selection');
  if (selectionSection) {
    selectionSection.style.display = 'block';
  }
  
  // Обновляем количество требуемых мест
  document.getElementById('totalRequiredSeats').textContent = currentQuantity;
}

// Визуализация зала для покупки
function visualizeHallForPurchase() {
  const container = document.getElementById('purchaseHallLayout');
  if (!container || !currentEventSeatingConfig) return;
  
  container.innerHTML = '';
  
  if (currentEventSeatingConfig.type === 'free') {
    visualizeFreeSeatingForPurchase();
  } else {
    visualizeReservedSeatingForPurchase();
  }
}

// Упрощенная визуализация зала
function visualizeHallForPurchase() {
    debugLog('Визуализация зала запущена');
    
    const container = document.getElementById('purchaseHallLayout');
    if (!container) {
        debugLog('Ошибка: контейнер зала не найден');
        return;
    }

    // Очищаем контейнер
    container.innerHTML = '';
    debugLog('Контейнер очищен');

    if (!currentEventSeatingConfig) {
        debugLog('Ошибка: конфигурация мест не определена');
        container.innerHTML = '<div class="error">Конфигурация мест не определена</div>';
        return;
    }

    // Проверяем тип рассадки
    if (currentEventSeatingConfig.type === 'free') {
        debugLog('Тип: свободная рассадка');
        visualizeFreeSeating();
    } else if (currentEventSeatingConfig.type === 'reserved' && currentEventSeatingConfig.sections) {
        debugLog('Тип: reserved seating');
        visualizeReservedSeating();
    } else {
        debugLog('Неизвестный тип рассадки: ' + currentEventSeatingConfig.type);
        container.innerHTML = '<div class="error">Неизвестный тип рассадки</div>';
    }
}

// Визуализация reserved seating
function visualizeReservedSeatingForPurchase() {
  const container = document.getElementById('purchaseHallLayout');
  
  currentEventSeatingConfig.sections.forEach(section => {
    // Заголовок секции
    const sectionHeader = document.createElement('div');
    sectionHeader.className = 'section-header';
    sectionHeader.innerHTML = `<h4>${section.name} - ${section.price} тг.</h4>`;
    container.appendChild(sectionHeader);
    
    // Места секции
    for (let row = 1; row <= section.rows; row++) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'hall-row';
      
      const rowNumber = document.createElement('div');
      rowNumber.className = 'row-number';
      rowNumber.textContent = row;
      rowDiv.appendChild(rowNumber);
      
      for (let seat = 1; seat <= section.seatsPerRow; seat++) {
        const seatDiv = createSeatElement(section.name, row, seat);
        rowDiv.appendChild(seatDiv);
      }
      
      container.appendChild(rowDiv);
    }
  });
}

// Создание элемента места
function createSeatElement(section, row, number) {
  const seatDiv = document.createElement('div');
  seatDiv.className = 'seat';
  
  // Проверяем занятость места
  const isTaken = isSeatTaken(section, row, number);
  const isSelected = isSeatSelected(section, row, number);
  
  if (isTaken) {
    seatDiv.className = 'seat taken';
    seatDiv.title = 'Место занято';
  } else if (isSelected) {
    seatDiv.className = 'seat selected';
    seatDiv.title = 'Выбрано вами';
  } else {
    seatDiv.className = 'seat free';
    seatDiv.title = `${section}, Ряд ${row}, Место ${number}`;
    
    // Добавляем обработчик клика только для свободных мест
    seatDiv.addEventListener('click', () => handleSeatClick(section, row, number));
  }
  
  seatDiv.textContent = number;
  seatDiv.setAttribute('data-section', section);
  seatDiv.setAttribute('data-row', row);
  seatDiv.setAttribute('data-number', number);
  
  return seatDiv;
}

// Обработчик клика по месту
function handleSeatClick(section, row, number) {
  // Проверяем, можно ли выбрать еще места
  if (selectedSeats.length >= currentQuantity && 
      !isSeatSelected(section, row, number)) {
    notifications.warning('Внимание', `Вы уже выбрали ${currentQuantity} мест(а)`);
    return;
  }
  
  // Переключаем выбор места
  toggleSeatSelection(section, row, number);
}

// Переключение выбора места
function toggleSeatSelection(section, row, number) {
  const index = selectedSeats.findIndex(seat => 
    seat.section === section && seat.row === row && seat.number === number
  );
  
  if (index > -1) {
    // Убираем из выбранных
    selectedSeats.splice(index, 1);
  } else {
    // Добавляем в выбранные
    selectedSeats.push({ section, row, number });
  }
  
  // Обновляем визуализацию
  updateSeatVisualization();
  updateSelectionStats();
}

// Обновление визуализации мест
function updateSeatVisualization() {
  document.querySelectorAll('#purchaseHallLayout .seat').forEach(seat => {
    const section = seat.getAttribute('data-section');
    const row = parseInt(seat.getAttribute('data-row'));
    const number = parseInt(seat.getAttribute('data-number'));
    
    seat.classList.remove('selected');
    
    if (isSeatSelected(section, row, number)) {
      seat.classList.add('selected');
    }
  });
}

// Проверка выбора места
function isSeatSelected(section, row, number) {
  return selectedSeats.some(seat => 
    seat.section === section && 
    seat.row === row && 
    seat.number === number
  );
}

// Обновление статистики
function updateSelectionStats() {
  document.getElementById('selectedSeatsCount').textContent = selectedSeats.length;
  
  // Показываем предупреждение если выбрано недостаточно мест
  if (selectedSeats.length < currentQuantity && currentEventSeatingConfig.type === 'reserved') {
    notifications.info('Выбор мест', `Выберите еще ${currentQuantity - selectedSeats.length} мест(а)`);
  }
}

// Очистка выбора
function clearSelection() {
  selectedSeats = [];
  updateSeatVisualization();
  updateSelectionStats();
  notifications.info('Выбор мест', 'Выбор очищен');
}

// Загрузка занятых мест
async function loadTakenSeats(eventId) {
    try {
        const response = await fetch(`/api/events/${eventId}/taken-seats`);
        const data = await response.json();
        
        if (data.status === 'success') {
            takenSeats = data.takenSeats;
            console.log('Загружено занятых мест:', takenSeats.length);
        }
    } catch (error) {
        console.error('Ошибка загрузки занятых мест:', error);
    }
}

// Проверка занятости места
function isSeatTaken(section, row, number) {
  return takenSeats.some(seat => 
    seat.section === section && 
    seat.seatRow === row && 
    seat.seatNumber === number
  );
}



// Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            if (currentEvent) {
    setTimeout(initSeatSelection, 100);
  }
        });

        function initSimpleHall() {
    console.log('Инициализация простого зала...');
    
    if (!currentEvent) {
        console.log('Мероприятие не загружено');
        return;
    }
    
    const container = document.getElementById('simpleHallLayout');
    if (!container) {
        console.log('Контейнер зала не найден');
        return;
    }
    
    // Очищаем контейнер
    container.innerHTML = '';
    
    // Получаем конфигурацию
    const config = currentEvent.seatingConfig || { type: 'free', rows: 5, seatsPerRow: 10 };
    console.log('Конфигурация зала:', config);
    
    // Обновляем количество требуемых мест
    document.getElementById('requiredCount').textContent = currentQuantity;
    
    // Создаем визуализацию
    if (config.type === 'free') {
        createFreeSeating(config);
    } else if (config.type === 'reserved' && config.sections) {
        createReservedSeating(config);
    } else {
        container.innerHTML = '<div class="no-seating">Конфигурация мест не определена</div>';
    }
}

// Создание свободной рассадки
function createFreeSeating(config) {
    const container = document.getElementById('simpleHallLayout');
    const rows = config.rows || 5;
    const seatsPerRow = config.seatsPerRow || 10;
    
    for (let row = 1; row <= rows; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'simple-row';
        
        const rowLabel = document.createElement('div');
        rowLabel.className = 'row-label';
        rowLabel.textContent = row;
        rowDiv.appendChild(rowLabel);
        
        for (let seat = 1; seat <= seatsPerRow; seat++) {
            const seatDiv = document.createElement('div');
            seatDiv.className = 'simple-seat free';
            seatDiv.textContent = seat;
            seatDiv.title = `Ряд ${row}, Место ${seat}`;
            
            // Проверяем занятость
            if (isSeatTaken('main', row, seat)) {
                seatDiv.className = 'simple-seat taken';
                seatDiv.title = 'Занято';
            } else {
                seatDiv.onclick = () => selectSimpleSeat('main', row, seat);
            }
            
            // Проверяем выбор
            if (isSeatSelected('main', row, seat)) {
                seatDiv.className = 'simple-seat selected';
            }
            
            rowDiv.appendChild(seatDiv);
        }
        
        container.appendChild(rowDiv);
    }
}

// Функции для работы с QR-кодами (интеграция из tickets.js)
function generateQRCode(ticket, container) {
  if (!window.QRCode) {
    container.innerHTML = '<div class="qr-code-placeholder">QR-код<br>недоступен</div>';
    return;
  }
  
  const qrData = JSON.stringify({
    code: ticket.code,
    event: currentEvent.title,
    date: currentEvent.date,
    time: currentEvent.time,
    seat: ticket.seat,
    price: ticket.price
  });
  
  try {
    QRCode.toCanvas(container, qrData, {
      width: 100,
      height: 100,
      margin: 1,
      color: {
        dark: '#2d3748',
        light: '#ffffff'
      }
    }, function(error) {
      if (error) {
        console.error('Ошибка генерации QR-кода:', error);
        container.innerHTML = '<div class="qr-code-placeholder">Ошибка<br>QR-кода</div>';
      }
    });
  } catch (error) {
    container.innerHTML = '<div class="qr-code-placeholder">QR-код<br>недоступен</div>';
  }
}

// Функция отображения модального окна с купленными билетами
function showPurchaseSuccess(tickets) {
  if (!tickets || tickets.length === 0) return;
  
  // Обновляем информацию о покупке
  const totalPrice = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
  document.getElementById('purchasedTicketsCount').textContent = tickets.length;
  document.getElementById('purchasedTotalPrice').textContent = totalPrice;
  
  // Очищаем контейнеры
//   document.getElementById('purchaseQrCodes').innerHTML = '';
//   document.getElementById('ticketCodesContainer').innerHTML = '';
  
  // Добавляем QR-коды и коды билетов

  // Показываем модальное окно
  openPurchaseSuccessModal();
}



// Функции управления модальным окном
function openPurchaseSuccessModal() {
  document.getElementById('purchaseSuccessModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePurchaseSuccessModal() {
  document.getElementById('purchaseSuccessModal').classList.remove('active');
  document.body.style.overflow = '';
}

// Вспомогательные функции
function copyTicketCode(code) {
  navigator.clipboard.writeText(code).then(() => {
    alert(`Скопировано! Код ${code} скопирован в буфер обмена`);
  }).catch(err => {
    console.error('Ошибка копирования:', err);
  });
}

function viewQRCode(ticketCode) {
  const canvas = document.querySelector(`#purchase-qr-${ticketCode} canvas`);
  if (!canvas) return;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    cursor: pointer;
  `;
  
  const img = new Image();
  img.src = canvas.toDataURL('image/png');
  img.style.cssText = `
    max-width: 80%;
    max-height: 70%;
    border: 15px solid white;
    border-radius: 15px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.5);
  `;
  
  const codeText = document.createElement('div');
  codeText.textContent = `Билет: ${ticketCode}`;
  codeText.style.cssText = `
    color: white;
    font-size: 1.2rem;
    margin-top: 20px;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.1);
    padding: 10px 20px;
    border-radius: 20px;
  `;
  
  modal.appendChild(img);
  modal.appendChild(codeText);
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

function saveAllQRCodes() {
  const canvases = document.querySelectorAll('#purchaseQrCodes canvas');
  if (canvases.length === 0) return;
  
  if (canvases.length === 1) {
    // Если один QR-код, скачиваем его
    downloadQRCode(canvases[0]);
  } else {
    // Если несколько QR-кодов, предлагаем zip-архив
    alert('info', 'Скачивание', 'Подготовка архива с QR-кодами...');
    
    // Здесь можно добавить логику создания zip-архива
    // Для простоты скачиваем каждый QR-код по отдельности
    canvases.forEach((canvas, index) => {
      setTimeout(() => {
        downloadQRCode(canvas, `ticket-${index + 1}.png`);
      }, index * 300);
    });
  }
}

function downloadQRCode(canvas, filename = 'ticket.png') {
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// Обработчики для модального окна
document.addEventListener('click', function(e) {
  const modal = document.getElementById('purchaseSuccessModal');
  if (modal && modal.classList.contains('active') && e.target === modal) {
    closePurchaseSuccessModal();
  }
});

document.addEventListener('keydown', function(e) {
  const modal = document.getElementById('purchaseSuccessModal');
  if (modal && modal.classList.contains('active') && e.key === 'Escape') {
    closePurchaseSuccessModal();
  }
});

// Создание reserved seating
function createReservedSeating(config) {
    const container = document.getElementById('simpleHallLayout');
    
    config.sections.forEach((section, sectionIndex) => {
        // Заголовок секции
        const sectionHeader = document.createElement('div');
        sectionHeader.className = 'section-header-simple';
        sectionHeader.innerHTML = `<h4>${section.name}</h4>`;
        container.appendChild(sectionHeader);
        
        // Места секции
        for (let row = 1; row <= section.rows; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'simple-row';
            
            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-label';
            rowLabel.textContent = row;
            rowDiv.appendChild(rowLabel);
            
            for (let seat = 1; seat <= section.seatsPerRow; seat++) {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'simple-seat free';
                seatDiv.textContent = seat;
                seatDiv.title = `${section.name}, Ряд ${row}, Место ${seat}`;
                seatDiv.style.borderColor = section.color || '#3a86ff';
                
                // Проверяем занятость
                if (isSeatTaken(section.name, row, seat)) {
                    seatDiv.className = 'simple-seat taken';
                    seatDiv.title = 'Занято';
                } else {
                    seatDiv.onclick = () => selectSimpleSeat(section.name, row, seat);
                }
                
                // Проверяем выбор
                if (isSeatSelected(section.name, row, seat)) {
                    seatDiv.className = 'simple-seat selected';
                }
                
                rowDiv.appendChild(seatDiv);
            }
            
            container.appendChild(rowDiv);
        }
        
        // Разделитель между секциями (кроме последней)
        if (sectionIndex < config.sections.length - 1) {
            const divider = document.createElement('div');
            divider.className = 'section-divider';
            divider.innerHTML = '────────────';
            container.appendChild(divider);
        }
    });
}

// Вспомогательные функции для извлечения ряда и места
function getRowFromSeat(seat) {
  if (!seat) return '-';
  const match = seat.match(/Ряд\s*(\d+)/i);
  return match ? match[1] : '-';
}

function getSeatNumberFromSeat(seat) {
  if (!seat) return '-';
  const match = seat.match(/Место\s*(\d+)/i);
  return match ? match[1] : '-';
}
function createTicketElement(ticket, index) {
  const ticketDiv = document.createElement('div');
  ticketDiv.className = 'ticket-item';
  ticketDiv.style.animationDelay = `${index * 0.05}s`;
  
  const eventDate = ticket.event?.date ? new Date(ticket.event.date).toLocaleDateString('ru-RU') : '-';
  const eventTime = ticket.event?.time || '-';
  
  ticketDiv.innerHTML = `
    <div class="ticket-qr" id="qr-${ticket.code}">
      <div class="ticket-qr-placeholder">Загрузка QR...</div>
    </div>
    
    <div class="ticket-main-info">
      <div class="ticket-header">
        <span class="ticket-code">${ticket.code || 'N/A'}</span>
        <span class="ticket-status status-${getStatusClass(ticket.status)}">
          ${ticket.status || 'Активен'}
        </span>
      </div>
      
      <div class="ticket-event-info">
        <div class="ticket-event-title" title="${ticket.event?.title || 'Неизвестно'}">
          ${ticket.event?.title || 'Неизвестно'}
        </div>
        <div class="ticket-event-details">
          <span title="${eventDate}">
            <i class="fas fa-calendar"></i> ${eventDate}
          </span>
          <span title="${eventTime}">
            <i class="fas fa-clock"></i> ${eventTime}
          </span>
        </div>
      </div>
      
      <div class="ticket-details">
        <div class="ticket-detail-item">
          <span class="ticket-detail-label">Место</span>
          <span class="ticket-detail-value" title="${ticket.seat || 'Не указано'}">
            ${ticket.seat || 'Не указано'}
          </span>
        </div>
        
        <div class="ticket-detail-item">
          <span class="ticket-detail-label">Цена</span>
          <span class="ticket-detail-value">${ticket.price || 0} тг.</span>
        </div>
        
        <div class="ticket-detail-item">
          <span class="ticket-detail-label">Ряд</span>
          <span class="ticket-detail-value">${getRowFromSeat(ticket.seat)}</span>
        </div>
        
        <div class="ticket-detail-item">
          <span class="ticket-detail-label">Место</span>
          <span class="ticket-detail-value">${getSeatNumberFromSeat(ticket.seat)}</span>
        </div>
      </div>
      
    

      </div>
    </div>
  `;
  
  // Генерируем QR-код после добавления в DOM
  setTimeout(() => {
    const qrContainer = ticketDiv.querySelector(`#qr-${ticket.code}`);
    if (qrContainer) {
      generateQRCode(ticket, qrContainer);
    }
  }, 100);
  
  return ticketDiv;
}

// Простой выбор места
function selectSimpleSeat(section, row, number) {
    console.log('Выбор места:', section, row, number);
    
    // Проверяем лимит выбора
    if (selectedSeats.length >= currentQuantity && !isSeatSelected(section, row, number)) {
        alert(`Можно выбрать только ${currentQuantity} мест(а)`);
        return;
    }
    
    // Переключаем выбор
    const index = selectedSeats.findIndex(s => 
        s.section === section && s.row === row && s.number === number
    );
    
    if (index > -1) {
        selectedSeats.splice(index, 1);
    } else {
        selectedSeats.push({ section, row, number });
    }
    
    // Перерисовываем зал
    initSimpleHall();
    updateSimpleSelectionInfo();
}




// Очистка выбора
function clearSimpleSelection() {
    selectedSeats = [];
    initSimpleHall();
    updateSimpleSelectionInfo();
    alert('Выбор очищен');
}

// Проверка занятости места
function isSeatTaken(section, row, number) {
    return takenSeats.some(seat => 
        seat.section === section && 
        seat.seatRow === row && 
        seat.seatNumber === number
    );
}

// Проверка выбора места
function isSeatSelected(section, row, number) {
    return selectedSeats.some(seat => 
        seat.section === section && 
        seat.row === row && 
        seat.number === number
    );
}

// Функция открытия страницы печати
function openPrintPage() {
  // Скрываем модальное окно
  closePurchaseSuccessModal();
  
  // Показываем страницу печати
  document.getElementById('printPage').style.display = 'block';
  
   // Заполняем информацию о мероприятии
  document.getElementById('printEventTitle').textContent = currentEvent.title;
  document.getElementById('printEventDate').textContent = 
    `${new Date(currentEvent.date).toLocaleDateString('ru-RU')} в ${currentEvent.time}`;
  document.getElementById('printEventLocation').textContent = 
    `${currentEvent.venue}, ${currentEvent.city}`;
  document.getElementById('printGenerationDate').textContent = 
    new Date().toLocaleString('ru-RU');
  
  // Генерируем билеты для печати
  generatePrintTickets(purchasedTickets);
  
}

// Функция закрытия страницы печати
function closePrintPage() {
  document.getElementById('printPage').style.display = 'none';
  currentPrintTickets = [];
}

// Добавляем обработчик Escape для закрытия страницы печати
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('printPage').style.display === 'block') {
    closePrintPage();
  }
});

// Переменная для хранения купленных билетов
let purchasedTickets = [];

// Обновляем функцию showPurchaseSuccess
function showPurchaseSuccess(tickets) {
  if (!tickets || tickets.length === 0) return;
  
  // Сохраняем билеты для печати
  purchasedTickets = tickets;
  
  const totalPrice = tickets.reduce((sum, ticket) => sum + (ticket.price || 0), 0);
  document.getElementById('purchasedTicketsCount').textContent = tickets.length;
  document.getElementById('purchasedTotalPrice').textContent = totalPrice;
  
  // Очищаем контейнер предпросмотра
  const previewContainer = document.getElementById('ticketCodesPreview');
  previewContainer.innerHTML = '';
  
  // Добавляем коды билетов в предпросмотр
  tickets.forEach(ticket => {
    const codeBadge = document.createElement('span');
    codeBadge.className = 'ticket-code-badge';
    codeBadge.textContent = ticket.code;
    codeBadge.title = `Место: ${ticket.seat || 'не указано'}`;
    previewContainer.appendChild(codeBadge);
  });
  
  // Показываем модальное окно
  openPurchaseSuccessModal();
}

// Генерация билетов для печати
async function generatePrintTickets(tickets) {
  const container = document.getElementById('printTicketsContainer');
  container.innerHTML = '';
  
  for (const ticket of tickets) {
    const ticketElement = await createPrintTicketElement(ticket);
    container.appendChild(ticketElement);
  }
}

// Создание элемента билета для печати
async function createPrintTicketElement(ticket) {
  const ticketDiv = document.createElement('div');
  ticketDiv.className = 'print-ticket';
  
  const eventDate = ticket.event?.date ? new Date(ticket.event.date).toLocaleDateString('ru-RU') : '-';
  
  ticketDiv.innerHTML = `
    <div class="print-ticket-header">
      <span class="print-ticket-code">${ticket.code || 'N/A'}</span>
      <span class="print-ticket-status status-active">Активен</span>
    </div>
    
    <div class="print-ticket-info">
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Мероприятие:</span>
        <span class="print-ticket-info-value">${ticket.event?.title || 'Неизвестно'}</span>
      </div>
      
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Дата:</span>
        <span class="print-ticket-info-value">${eventDate}</span>
      </div>
      
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Время:</span>
        <span class="print-ticket-info-value">${ticket.event?.time || '-'}</span>
      </div>
      
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Место:</span>
        <span class="print-ticket-info-value">${ticket.seat || 'Не указано'}</span>
      </div>
      
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Цена:</span>
        <span class="print-ticket-info-value">${ticket.price || 0} тг.</span>
      </div>
      
      <div class="print-ticket-info-item">
        <span class="print-ticket-info-label">Место проведения:</span>
        <span class="print-ticket-info-value">${ticket.event?.venue || '-'}, ${ticket.event?.city || '-'}</span>
      </div>
    </div>
    
    <div class="print-ticket-qr" id="print-qr-${ticket.code}">
      <div class="qr-loading">Генерация QR-кода...</div>
    </div>
    
    <div class="print-ticket-footer">
      Предъявите этот билет на входе. Билет действителен только при предъявлении QR-кода.
    </div>
  `;
  
  // Генерируем QR-код для печати
  await generateQRForPrint(ticket, ticketDiv.querySelector('.print-ticket-qr'));
  
  return ticketDiv;
}

// Генерация QR-кода для печати
async function generateQRForPrint(ticket, container) {
  try {
    if (!window.QRCode) {
      // Если библиотека не загружена, показываем код текстом
      container.innerHTML = `
        <div style="text-align: center; padding: 10px;">
          <div style="font-family: monospace; font-size: 10px; margin-bottom: 5px;">
            Код билета:
          </div>
          <div style="font-family: monospace; font-weight: bold; font-size: 14px;">
            ${ticket.code}
          </div>
        </div>
      `;
      return;
    }
    
    const qrData = JSON.stringify({
      code: ticket.code,
      event: currentEvent.title,
      date: currentEvent.date,
      time: currentEvent.time,
      seat: ticket.seat,
      price: ticket.price
    });
    
    QRCode.toCanvas(container, qrData, {
      width: 120,
      height: 120,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    });
    
  } catch (error) {
    console.error('Ошибка генерации QR-кода для печати:', error);
    container.innerHTML = `
      <div style="text-align: center; padding: 10px;">
        <div style="font-family: monospace; font-size: 12px;">
          ${ticket.code}
        </div>
      </div>
    `;
  }
}

// Функция копирования всех кодов билетов
function copyAllTicketCodes() {
  const codes = purchasedTickets.map(t => t.code).join('\n');
  
  navigator.clipboard.writeText(codes).then(() => {
    alert('Скопировано! Все коды билетов скопированы в буфер обмена');
  }).catch(err => {
    console.error('Ошибка копирования:', err);
    alert('Ошибка! Не удалось скопировать коды');
  });
}

// Закрытие страницы печати
function closePrintPage() {
  document.getElementById('printPage').style.display = 'none';
}

// Обработчик для кнопки "Назад" на странице печати
function addPrintPageBackButton() {
  const printPage = document.getElementById('printPage');
  if (!printPage) return;
  
  const backButton = document.createElement('button');
  backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Назад';
  backButton.className = 'btn-secondary no-print';
  backButton.style.cssText = `
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
  `;
  backButton.onclick = closePrintPage;
  
  printPage.appendChild(backButton);
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
  addPrintPageBackButton();
});

// Переменная для хранения текущих билетов
let currentPrintTickets = [];
// Функция скачивания как PNG


// Функция скачивания как PDF с форматом А4
async function downloadAsPDF() {
  try {
    showLoading('Генерация PDF...');
    
    const tickets = document.querySelectorAll('.print-ticket');
const canvasPromises = Array.from(tickets).map(async (ticketElement, index) => {
  const canvas = await html2canvas(ticketElement);
  const ticketObj = currentPrintTickets[index];
  const code = ticketObj && ticketObj.code ? ticketObj.code : `unknown-${index+1}`;
  return {
    canvas,
    filename: `билет-${code}.png`
  };
});
    
    if (tickets.length === 0) {
      alert('Ошибка! Нет билетов для скачивания');
      return;
    }
    
    // Создаем новый PDF документ
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    // Размеры страницы А4 в мм
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15; // Отступы со всех сторон
    
    // Доступная область для контента
    const contentWidth = pageWidth - margin * 2;
    const contentHeight = pageHeight - margin * 2;
    
    // Генерируем каждый билет на отдельной странице А4
    for (let i = 0; i < tickets.length; i++) {
      if (i > 0) {
        doc.addPage(); // Новая страница для каждого билета
      }
      
      const ticketElement = tickets[i];
      const canvas = await html2canvas(ticketElement, {
        scale: 2, // Увеличиваем качество
        useCORS: true,
        logging: false
      });
      
      const imgData = canvas.toDataURL('image/png', 1.0);
      
      // Рассчитываем размеры для сохранения пропорций
      const imgRatio = canvas.width / canvas.height;
      let imgWidth = contentWidth;
      let imgHeight = contentWidth / imgRatio;
      
      // Если высота слишком большая, масштабируем по высоте
      if (imgHeight > contentHeight) {
        imgHeight = contentHeight;
        imgWidth = contentHeight * imgRatio;
      }
      
      // Центрируем изображение на странице
      const x = margin + (contentWidth - imgWidth) / 2;
      const y = margin + (contentHeight - imgHeight) / 2;
      
      // Добавляем изображение в PDF
      doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
      
      // Добавляем номер страницы (если нужно)
      if (tickets.length > 1) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Билет ${i + 1} из ${tickets.length}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      }
    }
    
    // Сохраняем PDF
    doc.save('билеты.pdf');
    
    alert('Успешно! Билеты скачаны как PDF');
    
  } catch (error) {
    console.error('Ошибка генерации PDF:', error);
    alert('Ошибка! Не удалось создать PDF файл');
  } finally {
    hideLoading();
  }
}

// Вспомогательная функция для загрузки скриптов
function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// Функции для показа/скрытия загрузки
function showLoading(message = 'Загрузка...') {
  // Создаем или находим элемент загрузки
  let loadingElement = document.getElementById('loadingOverlay');
  
  if (!loadingElement) {
    loadingElement = document.createElement('div');
    loadingElement.id = 'loadingOverlay';
    loadingElement.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10002;
      color: white;
      font-size: 18px;
    `;
    document.body.appendChild(loadingElement);
  }
  
  loadingElement.innerHTML = `
    <div style="text-align: center;">
      <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 15px;"></i>
      <div>${message}</div>
    </div>
  `;
  
  loadingElement.style.display = 'flex';
}



const canvasPromises = Array.from(tickets).map(async (ticketElement, index) => {
  const canvas = await html2canvas(ticketElement);
  const ticketObj = currentPrintTickets[index];
  const code = ticketObj && ticketObj.code ? ticketObj.code : `unknown-${index+1}`;
  return {
    canvas,
    filename: `билет-${code}.png`
  };
});

// Функция предпросмотра PDF
async function previewPDF() {
  try {
    showLoading('Подготовка предпросмотра...');
    
    // Здесь можно реализовать предпросмотр в новом окне
    // или использовать PDF.js для встроенного просмотра
    
    // Временное решение - скачиваем и предлагаем открыть
    await downloadAsPDF();
    
  } catch (error) {
    console.error('Ошибка предпросмотра:', error);
    alert('Не удалось создать предпросмотр!');
  } finally {
    hideLoading();
  }
}

// Добавляем кнопку предпросмотра в интерфейс
function addPreviewButton() {
  const controls = document.querySelector('.print-controls');
  if (controls) {
    const previewBtn = document.createElement('button');
    previewBtn.className = 'btn-secondary';
    previewBtn.innerHTML = '<i class="fas fa-eye"></i> Предпросмотр';
    previewBtn.onclick = previewPDF;
    controls.appendChild(previewBtn);
  }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
  addPreviewButton();
});




    </script>
    <script src="/js/tickets.js"></script>
</body>
</html>